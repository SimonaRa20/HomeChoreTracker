@page
@model HomeChoreTracker.Portal.Pages.Challenges.IndexModel

@{
	ViewData["Title"] = "Challenges";
}
@if (!User.Identity.IsAuthenticated)
{
	Response.Redirect("/Auth/Login");
}
else if (User.IsInRole("User"))
{
	<div class="row">
		<div class="col-lg-12">
			<a class="btn btn-secondary btn-sm mb-2" href="~/Challenges"><i class="fas fa-user fa-sm fa-fw mr-2"></i>Current Challenges</a>
			<a class="btn btn-light btn-sm mb-2" asp-page="./Create"><i class="fa fa-hourglass-start mr-2" aria-hidden="true"></i>Create challenge</a>
			<a class="btn btn-light btn-sm mb-2" asp-page="./History"><i class="fa fa-user-astronaut mr-2" aria-hidden="true"></i>History</a>

			<div class="card mb-4 py-3 border-left-primary">
				<div class="card-body">
					@if (Model.ChallengesResponse != null && Model.ChallengesResponse.Any())
					{
						<h4>Received challenges</h4>
						<div class="table-responsive">
							<table class="table table-bordered">
							<thead>
								<tr>
									<th>Invitee opponent</th>
									<th>Invited opponent</th>
									<th>Challenge home/user</th>
									<th>Challenge type</th>
									<th>Tasks/Points</th>
									<th>Time</th>
									<th>Action</th>
								</tr>
							</thead>
							<tbody>
								@foreach (var challenge in Model.ChallengesResponse)
								{
									<tr>
										@if (challenge.OpponentType.Equals(HomeChoreTracker.Portal.Constants.OpponentType.User))
										{
											<td>@challenge.UserName</td>
											<td>@challenge.OpponentUserName</td>
										}
										else
										{
											<td>@challenge.HomeTitle</td>
											<td>@challenge.OpponentHomeTitle</td>
										}
										
										<td>@challenge.OpponentType</td>
										<td>@challenge.ChallengeType</td>
										<td>@challenge.ChallengeCount</td>
										<td>@challenge.Days d @challenge.Hours h @challenge.Minutes m @challenge.Seconds s</td>
										<td>
											<a class='btn btn-success text-white btn-sm' id='btnAccept' data-toggle="modal" data-target="#AcceptModal-@challenge.Id">Accept</a>
											<div class="modal" tabindex="-1" role="dialog" id="AcceptModal-@challenge.Id">
												<div class="modal-dialog" role="document">
													<div class="modal-content">
														<div class="modal-header">
															<h5 class="modal-title">Accept Confirmation</h5>
															<button type="button" class="close" data-dismiss="modal" aria-label="Close">
																<span aria-hidden="true">&times;</span>
															</button>
														</div>
														<div class="modal-body">
															<p>Are you sure you want to accept this '@challenge.ChallengeType' challenge?</p>
														</div>
														<div class="modal-footer">
															<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
																<form method="post" asp-page-handler="Accept" asp-route-challengeId="@challenge.Id">
																<button type="submit" class="btn btn-success">Accept</button>
															</form>
														</div>
													</div>
												</div>
											</div>

											<a class='btn btn-danger text-white btn-sm' id='btnDecline' data-toggle="modal" data-target="#DeclineModal-@challenge.Id">Decline</a>
											<div class="modal" tabindex="-1" role="dialog" id="DeclineModal-@challenge.Id">
												<div class="modal-dialog" role="document">
													<div class="modal-content">
														<div class="modal-header">
															<h5 class="modal-title">Decline Confirmation</h5>
															<button type="button" class="close" data-dismiss="modal" aria-label="Close">
																<span aria-hidden="true">&times;</span>
															</button>
														</div>
														<div class="modal-body">
															@if (challenge.OpponentType.Equals(HomeChoreTracker.Portal.Constants.OpponentType.User))
															{
																<p>Are you sure you want to decline this '@challenge.UserName vs @challenge.OpponentUserName' challenge?</p>
															}
															else
															{
																<p>Are you sure you want to decline this '@challenge.HomeTitle vs @challenge.OpponentHomeTitle' challenge?</p>
															}
															
														</div>
														<div class="modal-footer">
															<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
															<form method="post" asp-page-handler="Decline" asp-route-challengeId="@challenge.Id">
																<button type="submit" class="btn btn-danger">Decline</button>
															</form>
														</div>
													</div>
												</div>
											</div>
										</td>

									</tr>
								}
							</tbody>
						</table>
						</div>
					}
					else
					{
						<p>No received challenges found.</p>
					}
				</div>
			</div>

			<div class="card mb-4 py-3 border-left-primary">
				<div class="card-body">
					@if (Model.CurrentChallengeResponses != null && Model.CurrentChallengeResponses.Any())
					{
						<h4>Current challenges</h4>
						<div class="table-responsive">
							<table class="table table-bordered">
								<thead>
									<tr>
										<th>Invitee opponent</th>
										<th>Invited opponent</th>
										<th>Challenge home/user</th>
										<th>Challenge type</th>
										<th>Tasks/Points</th>
										<th>Time</th>
										<th>Invitee progress</th>
										<th>Invited progress</th>
									</tr>
								</thead>
								<tbody>
									@foreach (var challenge in Model.CurrentChallengeResponses)
									{
										<tr>
											@if (challenge.OpponentType.Equals(HomeChoreTracker.Portal.Constants.OpponentType.User))
											{
												<td>@challenge.UserName</td>
												<td>@challenge.OpponentUserName</td>
											}
											else
											{
												<td>@challenge.HomeTitle</td>
												<td>@challenge.OpponentHomeTitle</td>
											}

											<td>@challenge.OpponentType</td>
											<td>@challenge.ChallengeType</td>
											<td>@challenge.ChallengeCount</td>
											<td>@challenge.EndTime</td>
											<td>
												<div class="row no-gutters align-items-center mb-4">
													<div class="col mr-2">
														
														<div class="row no-gutters align-items-center">
															@{
																var earnedPoints = (double)challenge.Count;
																var maxPoints = (double)challenge.ChallengeCount;
																var percentage = Math.Min(earnedPoints / maxPoints * 100, 100);
															}
															<div class="col">

																<div class="progress progress-sm mr-2">
																	<div class="progress-bar bg-primary" role="progressbar"
																		 style="width: @percentage%" aria-valuenow="@challenge.Count" aria-valuemin="0"
																		 aria-valuemax="@challenge.ChallengeCount"></div>
																</div>
															</div>
														</div>
														<div class="text-xs font-weight-bold text-primary text-uppercase mb-1 text-center">
															@challenge.Count / @challenge.ChallengeCount %
														</div>
													</div>
												</div>
											</td>
											<td>
												<div class="row no-gutters align-items-center mb-4">
													<div class="col mr-2">

														<div class="row no-gutters align-items-center">
															@{
																var earned = (double)challenge.OpponentCount;
																var max = (double)challenge.ChallengeCount;
																var percent = Math.Min(earned / max * 100, 100);
															}
															<div class="col">

																<div class="progress progress-sm mr-2">
																	<div class="progress-bar bg-primary" role="progressbar"
																		 style="width: @percent%" aria-valuenow="@challenge.OpponentCount" aria-valuemin="0"
																		 aria-valuemax="@challenge.ChallengeCount"></div>
																</div>
															</div>
														</div>
														<div class="text-xs font-weight-bold text-primary text-uppercase mb-1 text-center">
															@challenge.OpponentCount / @challenge.ChallengeCount %
														</div>
													</div>
												</div>
											</td>
										</tr>
									}
								</tbody>
							</table>
						</div>
					}
					else
					{
						<p>No received challenges found.</p>
					}
				</div>
			</div>
		</div>
	</div>
}
else
{
			<div class="row">
				<div class="col-lg-12">
					<div class="card mb-4 py-3 border-left-primary">
						<div class="collapse show">
							<div class="card-body">
								<p>You don't have permission to view this content.</p>
							</div>
						</div>
					</div>
				</div>
			</div>
}
