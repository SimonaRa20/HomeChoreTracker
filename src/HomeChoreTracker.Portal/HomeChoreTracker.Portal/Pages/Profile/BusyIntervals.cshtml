@page
@model HomeChoreTracker.Portal.Pages.Profile.BusyIntervalsModel
@{
	Layout = "~/Pages/Shared/_Layout.cshtml";
}
@section HeadContent
{
	<title>@ViewData["Title"] - Home Chore Tracker</title>
	<link href="~/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" asp-append-version="true">
	<link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
		  rel="stylesheet" asp-append-version="true">
	<link href="~/css/sb-admin-2.min.css" rel="stylesheet" asp-append-version="true">
	<!-- Add the following lines to include required Bootstrap and jQuery files -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
}
@if (!User.Identity.IsAuthenticated)
{
	Response.Redirect("/Auth/Login");
}
else if (User.IsInRole("User"))
{
	<div class="row">
		<div class="col-lg-12">
			<a class="btn btn-light btn-sm mb-2" href="/Profile"><i class="fas fa-user fa-sm fa-fw mr-2"></i>Profile</a>
			<a class="btn btn-secondary btn-sm mb-2" asp-page="./BusyIntervals"><i class="fa fa-hourglass-start mr-2" aria-hidden="true"></i>Busy Intervals</a>
			<a class="btn btn-light btn-sm mb-2" asp-page="./Avatars"><i class="fa fa-user-astronaut mr-2" aria-hidden="true"></i>Avatars</a>

			<div class="card border-left-primary">
				<div class="card-body">
					<h4>For home chores assignment busy intervals</h4>
					<div class="form-group">
						<button type="button" class="btn btn-primary btn-sm float-right mb-2" data-toggle="modal" data-target="#addIntervalModal">Add new busy interval</button>
					</div>
					<div class="modal fade" id="addIntervalModal" tabindex="-1" role="dialog" aria-labelledby="addIntervalModalLabel" aria-hidden="true">
						<div class="modal-dialog" role="document">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title" id="addIntervalModalLabel">Add New Busy Interval</h5>
									<button type="button" class="close" data-dismiss="modal" aria-label="Close">
										<span aria-hidden="true">&times;</span>
									</button>
								</div>
								<div class="modal-body">
									<form method="post" asp-page-handler="NewBusyInterval" id="newBusyIntervalForm" onsubmit="validateForm(); return false;">
										<div class="form-group">
											<label for="DayOfWeek">Day of Week:</label>
											<select class="form-control" id="DayOfWeek" name="CreateBusyInterval.Day">
												<option value="1">Monday</option>
												<option value="2">Tuesday</option>
												<option value="3">Wednesday</option>
												<option value="4">Thursday</option>
												<option value="5">Friday</option>
												<option value="6">Saturday</option>
												<option value="0">Sunday</option>
											</select>
										</div>
										<div class="form-group">
											<label for="StartTime">Start Time:</label>
											<input type="time" class="form-control" id="StartTime" name="CreateBusyInterval.StartTime" asp-for="CreateBusyInterval.StartTime" />
											<span id="startError" class="text-danger"></span>
										</div>
										<div class="form-group">
											<label for="EndTime">End Time:</label>
											<input type="time" class="form-control" id="EndTime" name="CreateBusyInterval.EndTime" asp-for="CreateBusyInterval.EndTime" />
											<span id="endError" class="text-danger"></span>
										</div>
										<button type="submit" class="btn btn-primary">Add</button>
									</form>
								</div>
							</div>
						</div>
					</div>
					<div class="collapse show">
						<div class="card-body">

							@if (Model.BusyIntervals != null && Model.BusyIntervals.Any())
							{
								<table class="table">
									<thead>
										<tr>
											<th>Day</th>
											<th>Start time</th>
											<th>End time</th>
											<th>Action</th>
										</tr>
									</thead>
									<tbody>
										@foreach (var dayOfWeek in new[] { DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday, DayOfWeek.Friday, DayOfWeek.Saturday, DayOfWeek.Sunday })
										{
											<tr>
												<td>@dayOfWeek</td>
												<td>
													@if (Model.BusyIntervals.Any(i => i.Day == dayOfWeek))
													{
														@foreach (var interval in Model.BusyIntervals.Where(i => i.Day == dayOfWeek))
														{
															@interval.StartTime <br />
														}
													}
													else
													{
														<span>-</span>
													}
												</td>
												<td>
													@if (Model.BusyIntervals.Any(i => i.Day == dayOfWeek))
													{
														@foreach (var interval in Model.BusyIntervals.Where(i => i.Day == dayOfWeek))
														{
															@interval.EndTime <br />
														}
													}
													else
													{
														<span>-</span>
													}
												</td>
												<td>
													@if (Model.BusyIntervals.Any(i => i.Day == dayOfWeek))
													{
														@foreach (var interval in Model.BusyIntervals.Where(i => i.Day == dayOfWeek))
														{
															<button type="button" class="btn btn-sm btn-edit" style="margin-bottom:-8px; margin-top:-8px" data-toggle="modal" data-target="#EditModal-@interval.Id"><i class="fas fa-pencil-alt"></i></button>
															<div class="modal fade" id="EditModal-@interval.Id" tabindex="-1" role="dialog" aria-labelledby="EditModalLabel-@interval.Id" aria-hidden="true">
																<div class="modal-dialog" role="document">
																	<div class="modal-content">
																		<div class="modal-header">
																			<h5 class="modal-title">Edit Busy Interval</h5>
																			<button type="button" class="close" data-dismiss="modal" aria-label="Close">
																				<span aria-hidden="true">&times;</span>
																			</button>
																		</div>
																		<div class="modal-body">
																			<form method="post" asp-page-handler="EditBusyIntervals" id="editBusyIntervalForm-@interval.Id" onsubmit="return validateEditForm('@interval.Id');">
																				<input type="hidden" name="EditDay" value="@interval.Day" />
																				<input type="hidden" name="intervalId" value="@interval.Id" />
																				<div class="form-group">
																					<label for="EditStartTime">Start Time:</label>
																					<input type="time" class="form-control" id="EditStartTime-@interval.Id" name="EditStartTime" value="@interval.StartTime" />
																					<span id="editStartError-@interval.Id" class="text-danger"></span>
																				</div>
																				<div class="form-group">
																					<label for="EditEndTime">End Time:</label>
																					<input type="time" class="form-control" id="EditEndTime-@interval.Id" name="EditEndTime" value="@interval.EndTime" />
																					<span id="editEndError-@interval.Id" class="text-danger"></span>
																				</div>
																				<button type="submit" class="btn btn-primary">Save Changes</button>
																			</form>
																		</div>
																	</div>
																</div>
															</div>
															<button type="button" class="btn btn-sm btn-delete" style="margin-bottom:-8px; margin-top:-8px" data-toggle="modal" data-target="#DeleteModal-@interval.Id"><i class="fas fa-trash-alt"></i></button>
															<div class="modal fade" id="DeleteModal-@interval.Id" tabindex="-1" role="dialog" aria-labelledby="DeleteModalLabel-@interval.Id" aria-hidden="true">
																<div class="modal-dialog" role="document">
																	<div class="modal-content">
																		<div class="modal-header">
																			<h5 class="modal-title">Delete Confirmation</h5>
																			<button type="button" class="close" data-dismiss="modal" aria-label="Close">
																				<span aria-hidden="true">&times;</span>
																			</button>
																		</div>
																		<div class="modal-body">
																			<p>Are you sure you want to delete this '@interval.Day, @interval.StartTime / @interval.EndTime' busy interval?</p>
																		</div>
																		<div class="modal-footer">
																			<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
																			<form method="post" asp-page-handler="Delete" asp-route-id="@interval.Id">
																				<button type="submit" class="btn btn-danger">Delete</button>
																			</form>
																		</div>
																	</div>
																</div>
															</div>
															<br />
														}
													}
													else
													{
														<span>-</span>
													}
												</td>
											</tr>
										}
									</tbody>
								</table>
							}
							else
							{
								<p>No busy intervals found.</p>
							}
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
}
else
{
	<div class="row">
		<div class="col-lg-12">
			<div class="card mb-4 py-3 border-left-primary">
				<div class="collapse show">
					<div class="card-body">
						<p>You don't have permission to view this content.</p>
					</div>
				</div>
			</div>
		</div>
	</div>
}
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-K+1ClXaRhPU17yAPQnQA4Gn4kKgdCjP/vt3kS2uF78w=" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
	function validateForm() {
		var isValid = true;
		var startTime = $('#StartTime').val();
		var endTime = $('#EndTime').val();

		$('#startError').text('');
		$('#endError').text('');

		if (startTime.trim() === '') {
			$('#startError').text('Start time is required.');
			return false;
		}

		if (endTime.trim() === '') {
			$('#endError').text('End time is required.');
			return false;
		}

		if (startTime >= endTime) {
			$('#endError').text('End time must be greater than start time.');
			return false;
		}

		$('#newBusyIntervalForm').submit();
	}
</script>
<script>
	function validateEditForm(intervalId) {
		console.log('Start edit.');
		var isValid = true;

		var editStartTime = $('#EditStartTime-' + intervalId).val();
		var editEndTime = $('#EditEndTime-' + intervalId).val();

		$('#editStartError-' + intervalId).text('');
		$('#editEndError-' + intervalId).text('');

		if (editStartTime.trim() === '') {
			$('#editStartError-' + intervalId).text('Start time is required.');
			isValid = false;
		}

		if (editEndTime.trim() === '') {
			$('#editEndError-' + intervalId).text('End time is required.');
			isValid = false;
		}

		if (editStartTime >= editEndTime) {
			$('#editEndError-' + intervalId).text('End time must be greater than start time.');
			isValid = false;
		}

		return isValid;
	}
</script>


